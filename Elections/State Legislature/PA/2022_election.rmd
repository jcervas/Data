

```{r, variable names}
data_names <- c(
     "year",
     "type",
     "county",
     "prec",
     "office_code",
     "district",
     "party_code",
     "ballot_pos",
     "office",
     "party",
     "cand_num",
     "last",
     "first",
     "middle",
     "suffix",
     "vote",
     "yes",
     "no",
     "cong_dist",
     "sen_dist",
     "house_dist",
     "muni_type",
     "muni_name",
     "muni_breakdown_code_1",
     "muni_breakdown_name_1",
     "muni_breakdown_code_2",
     "muni_breakdown_name_2",
     "bicounty_code",
     "mcd",
     "fips",
     "vtd",
     "ballot_question",
     "record_type",
     "prev_prec_code",
     "prev_cong_dist",
     "prev_sen_dist",
     "prev_house_dist"
)
```

```{r, name=Functions}
source("https://raw.githubusercontent.com/jcervas/R-Functions/main/GERRYfunctions.R")

source("https://raw.githubusercontent.com/jcervas/R-Functions/main/sv-hyp.R")
```

```{r}
## https://www.dos.pa.gov/VotingElections/BEST/stats/_layouts/15/formspubs/formsandpubs.aspx
PA_g22 <- read.csv("https://www.dos.pa.gov/VotingElections/BEST/stats/Documents/ElectionReturns_2022_General_PrecinctReturns.txt", header=FALSE, stringsAsFactors=FALSE)
names(PA_g22) <- data_names
```

```{r}
g22 <- PA_g22

g22$GEOID20 <- paste0(42,leadingZeroes(g22$fips,3), substrRight(paste0("000000",g22$prec),6))
  length(unique(g22$GEOID20))

g22_reduced <- g22[names(g22) %in% c("fips", "GEOID20", "office", "party", "last", "prec", "cong_dist", "house_dist", "sen_dist", "vote", "muni_name")]
  head(g22_reduced)
```


```{r}


## collect election results wide by race/district
  ## house_dist, sen_dist, cong_dist
    elect_collect <- function(x,variable=NA) {
        if(is.na(variable)){stop("choose a variable to aggregate on.")}
      DEM <- subset(x, (party=="DEM"))
      GOP <- subset(x, (party=="REP"))
      OTH <- subset(x, (!party %in% c("DEM","REP")))

      tmp.dem <- aggregate(list(dem=DEM[,"vote"]), by=list(district=DEM[,variable]), FUN=sum)
      tmp.gop <- aggregate(list(gop=GOP[,"vote"]), by=list(district=GOP[,variable]), FUN=sum)
      tmp.oth <- aggregate(list(oth=OTH[,"vote"]), by=list(district=OTH[,variable]), FUN=sum)

      out <- merge(tmp.dem,tmp.gop, by="district", all = TRUE)
      out <- merge(out,tmp.oth, by="district", all = TRUE)
      out <- replaceNA(out)
      return(out)
    }
```

```{r}
offices <- c("USS", "GOV", "USC", "STH", "STS")
agg_type <- c("house_dist", "sen_dist", "cong_dist")

for (i in offices) {
  tmp <- subset(g22_reduced, (office==i))
  assign(i, tmp)
  print(i)
    for (j in agg_type) {
    j_tmp <- elect_collect(tmp, j)
      j_tmp$DEM <- default.unc(two_party(j_tmp$dem,j_tmp$gop))
    tmp_j <- assign(paste0(i,"_",j),j_tmp)
    print(paste0(i,"_",j))
    print(mean(1 * (j_tmp$DEM > 0.5)))
    write.csv(tmp_j, paste0("/Users/cervas/Downloads/2022 PA/",i,"_",j,".csv"), row.names=F)
    }
}

```


```{r}

```



```{r}

v_s_sim <- function(data, range_sim=seq(-0.1,0.1,0.01)) {
range_sim <- ifelse(is.na(range_sim), seq(-0.1,0.1,0.01), range_sim)
n <- length(range_sim)
votes_seats <- cbind(rep(NA, n), rep(NA,n))
colnames(votes_seats) <- c("votes","seats")
rownames(votes_seats) <- range_sim

  for (i in 1:n) {
    tmp <- data + range_sim[i]
    seats_tmp <- prop.table(table(1 * (tmp > 0.5)))
    votes_seats[i,1] <- mean(tmp)
    votes_seats[i,2] <- seats_tmp[2]
  }
  return(votes_seats)
}


to_plot <- list(USS_house_dist$DEM, GOV_house_dist$DEM, STS_house_dist$DEM, USC_house_dist$DEM, STH_house_dist$DEM)
v <- list()
s <- list()

seatsvotes.plot(main="PA House of Representatives")

for (i in 1:length(to_plot)) {
  v[[i]] <-v_s_sim(to_plot[[i]], range_sim=seq(-.2,.2,.01))[,1]
  s[[i]] <- v_s_sim(to_plot[[i]], range_sim=seq(-.2,.2,.01))[,2]
}


v <-v_s_sim(USS_house_dist$DEM)[,1]
s <- v_s_sim(USS_house_dist$DEM)[,2]

USS_v <- mean(USS_house_dist$DEM)
USS_s <- mean(find.winner(USS_house_dist$DEM))

sv_curve(s, v, lwd=0.5, col="gray70")

v <-v_s_sim(GOV_house_dist$DEM)[,1]
s <- v_s_sim(GOV_house_dist$DEM)[,2]

GOV_v <- mean(GOV_house_dist$DEM)
GOV_s <- mean(find.winner(GOV_house_dist$DEM))

sv_curve(s, v, lwd=0.5, col="gray70")


v <-v_s_sim(STS_house_dist$DEM)[,1]
s <- v_s_sim(STS_house_dist$DEM)[,2]

STS_v <- mean(STS_house_dist$DEM)
STS_s <- mean(find.winner(STS_house_dist$DEM))

sv_curve(s, v, lwd=0.5, col="gray70")

v <-v_s_sim(USC_house_dist$DEM)[,1]
s <- v_s_sim(USC_house_dist$DEM)[,2]

USC_v <- mean(USC_house_dist$DEM)
USC_s <- mean(find.winner(USC_house_dist$DEM))

sv_curve(s, v, lwd=0.5, col="gray70")


v <-v_s_sim(STH_house_dist$DEM, range_sim=seq(-.2,.2,.01))[,1]
s <- v_s_sim(STH_house_dist$DEM, range_sim=seq(-.2,.2,.01))[,2]

STH_v <- mean(STH_house_dist$DEM)
STH_s <- mean(STH_house_dist$DEM)

sv_curve(s, v, lwd=0.5, col="gray70")


v <- c(USS_v,GOV_v,STS_v,USC_v,STH_v)
s <- c(USS_s,GOV_s,STS_s,USC_s,STH_s)

## points(v,s)
sv_curve(s, v, lwd=1, col="gray30")

```



```{r}
v_s_sim <- function(data, range_sim=seq(-0.1,0.1,0.01)) {
  range_sim <- ifelse(is.na(range_sim), seq(-0.1,0.1,0.01), range_sim)
  n <- length(range_sim)
  votes_seats <- cbind(rep(NA, n), rep(NA,n))
  colnames(votes_seats) <- c("votes","seats")
  rownames(votes_seats) <- range_sim

  for (i in 1:n) {
    tmp <- default.unc(data + range_sim[i])
    seats_tmp <- prop.table(table(1 * (tmp > 0.5)))
    votes_seats[i,1] <- mean(tmp)
    votes_seats[i,2] <- seats_tmp[2]
  }
  return(votes_seats)
}

to_plot <- list(USS_sen_dist$DEM, GOV_sen_dist$DEM, STS_sen_dist$DEM, USC_sen_dist$DEM, STH_sen_dist$DEM)
v <- list()
s <- list()

seatsvotes.plot(main="PA Senate")

for (i in 1:length(to_plot)) {
  v[[i]] <-v_s_sim(to_plot[[i]], range_sim=seq(-.2,.2,.01))[,1]
  s[[i]] <- v_s_sim(to_plot[[i]], range_sim=seq(-.2,.2,.01))[,2]
}


v <-v_s_sim(USS_sen_dist$DEM)[,1]
s <- v_s_sim(USS_sen_dist$DEM)[,2]

USS_v <- mean(USS_sen_dist$DEM)
USS_s <- mean(find.winner(USS_sen_dist$DEM))

sv_curve(s, v, lwd=0.5, col="gray70")

v <-v_s_sim(GOV_sen_dist$DEM)[,1]
s <- v_s_sim(GOV_sen_dist$DEM)[,2]

GOV_v <- mean(GOV_sen_dist$DEM)
GOV_s <- mean(find.winner(GOV_sen_dist$DEM))

sv_curve(s, v, lwd=0.5, col="gray70")


v <-v_s_sim(STS_sen_dist$DEM)[,1]
s <- v_s_sim(STS_sen_dist$DEM)[,2]

STS_v <- mean(STS_sen_dist$DEM)
STS_s <- mean(find.winner(STS_sen_dist$DEM))

sv_curve(s, v, lwd=0.5, col="gray70")

v <-v_s_sim(USC_sen_dist$DEM)[,1]
s <- v_s_sim(USC_sen_dist$DEM)[,2]

USC_v <- mean(USC_sen_dist$DEM)
USC_s <- mean(find.winner(USC_sen_dist$DEM))

sv_curve(s, v, lwd=0.5, col="gray70")


v <-v_s_sim(STH_sen_dist$DEM, range_sim=seq(-.2,.2,.01))[,1]
s <- v_s_sim(STH_sen_dist$DEM, range_sim=seq(-.2,.2,.01))[,2]

STH_v <- mean(STH_sen_dist$DEM)
STH_s <- mean(STH_sen_dist$DEM)

sv_curve(s, v, lwd=0.5, col="gray70")


v <- c(USS_v,GOV_v,STS_v,USC_v,STH_v)
s <- c(USS_s,GOV_s,STS_s,USC_s,STH_s)

## points(v,s)
sv_curve(s, v, lwd=1, col="gray30")
```






```{r}
pa_census <- read.csv("/Users/cervas/My Drive/GitHub/Data/Elections/State Legislature/PA/PA-Census-10-20.csv")
census_bar <- pa_census[,c(4)]
names(census_bar) <- pa_census[,1]

```

